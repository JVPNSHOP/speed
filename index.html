<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Speedtest</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; max-width: 900px; }
    button { margin: 5px; padding: 8px 12px; }
    .results, .log { margin-top: 20px; }
    .log { background: #f6f6f6; padding: 10px; max-height: 250px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Simple Speedtest</h1>
  <p>Server: <span id="server">http://localhost:3001</span></p>
  <div>
    <button id="runAll">Run Test</button>
    <button id="pingBtn">Ping</button>
    <button id="downloadBtn">Download 10MB</button>
    <button id="uploadBtn">Upload 5MB</button>
    <button id="ipBtn">Get IP</button>
    <button id="locBtn">Get Location</button>
  </div>  <div class="results">
    <h3>Results</h3>
    <ul>
      <li>Ping: <span id="ping">—</span></li>
      <li>Download: <span id="download">—</span></li>
      <li>Upload: <span id="upload">—</span></li>
      <li>IP: <span id="ip">—</span></li>
      <li>Location: <span id="loc">—</span></li>
    </ul>
  </div>  <div class="log" id="log"></div>  <script>
    const SERVER = document.getElementById('server').textContent;

    function log(msg) {
      const logDiv = document.getElementById('log');
      const div = document.createElement('div');
      div.textContent = msg;
      logDiv.prepend(div);
    }

    async function measurePing(rounds = 5) {
      const times = [];
      for (let i = 0; i < rounds; i++) {
        const t0 = performance.now();
        await fetch(`${SERVER}/ping?x=${Math.random()}`);
        const t1 = performance.now();
        times.push(t1 - t0);
      }
      const avg = times.reduce((a,b)=>a+b,0)/times.length;
      document.getElementById('ping').textContent = avg.toFixed(2) + ' ms';
      log(`Ping avg ${avg.toFixed(2)} ms`);
      return avg;
    }

    async function measureDownload(mb = 10) {
      const url = `${SERVER}/download?mb=${mb}&x=${Math.random()}`;
      const t0 = performance.now();
      const resp = await fetch(url);
      const reader = resp.body.getReader();
      let received = 0;
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        received += value.length;
      }
      const t1 = performance.now();
      const secs = (t1 - t0) / 1000;
      const bits = received * 8;
      const mbps = bits / (secs * 1e6);
      document.getElementById('download').textContent = `${mbps.toFixed(2)} Mbps`;
      log(`Download ${mbps.toFixed(2)} Mbps`);
      return mbps;
    }

    async function measureUpload(mb = 5) {
      const size = mb * 1024 * 1024;
      const chunk = new Uint8Array(64 * 1024);
      const parts = [];
      let remaining = size;
      while (remaining > 0) {
        const take = Math.min(remaining, chunk.length);
        parts.push(chunk.slice(0, take));
        remaining -= take;
      }
      const blob = new Blob(parts);
      const t0 = performance.now();
      const resp = await fetch(`${SERVER}/upload?x=${Math.random()}`, {
        method: 'POST',
        body: blob
      });
      const json = await resp.json();
      const t1 = performance.now();
      const secs = (t1 - t0) / 1000;
      const bits = json.receivedBytes * 8;
      const mbps = bits / (secs * 1e6);
      document.getElementById('upload').textContent = `${mbps.toFixed(2)} Mbps`;
      log(`Upload ${mbps.toFixed(2)} Mbps`);
      return mbps;
    }

    async function getIP() {
      const r = await fetch(`${SERVER}/ip`);
      const j = await r.json();
      document.getElementById('ip').textContent = j.ip;
      log('IP ' + j.ip);
    }

    function getLocation() {
      if (!navigator.geolocation) {
        document.getElementById('loc').textContent = 'Not supported';
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        document.getElementById('loc').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        log(`Location ${latitude}, ${longitude}`);
      }, err => {
        document.getElementById('loc').textContent = err.message;
        log('Location error ' + err.message);
      });
    }

    async function runAll() {
      document.getElementById('ping').textContent = '…';
      document.getElementById('download').textContent = '…';
      document.getElementById('upload').textContent = '…';
      document.getElementById('ip').textContent = '…';
      document.getElementById('loc').textContent = '…';

      await getIP();
      getLocation();
      await measurePing();
      await measureDownload();
      await measureUpload();
    }

    document.getElementById('runAll').onclick = runAll;
    document.getElementById('pingBtn').onclick = () => measurePing();
    document.getElementById('downloadBtn').onclick = () => measureDownload();
    document.getElementById('uploadBtn').onclick = () => measureUpload();
    document.getElementById('ipBtn').onclick = getIP;
    document.getElementById('locBtn').onclick = getLocation;
  </script></body>
</html>
