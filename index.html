<!doctype html>
<html lang="my">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JK VIP SPEEDTEST</title>
<style>
  :root{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:#0b1020;color:#e9ecf1}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  .card{background:#121935;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
  .head{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid #27325c}
  .head img{width:40px;height:40px;border-radius:8px}
  .head h1{margin:0;font-size:22px;letter-spacing:.5px}
  .sub{margin:0 18px 10px;color:#9fb0d1}
  .info{display:flex;gap:14px;row-gap:6px;flex-wrap:wrap;margin:0 18px 14px}
  .chip{background:#0f1530;border:1px solid #27325c;border-radius:999px;padding:8px 12px;font-size:14px}
  .ok{color:#7cf0a6}
  .frame{width:100%;height:78vh;border:0;display:block;background:#0b1020}
  .foot{padding:12px 18px;color:#7f93c4;font-size:12px;border-top:1px solid #27325c}
  /* green spinner */
  .spin{width:18px;height:18px;border-radius:50%;border:3px solid rgba(124,240,166,.2);border-top-color:#7cf0a6;display:inline-block;vertical-align:-3px;animation:rot 1s linear infinite;margin-right:6px}
  @keyframes rot{to{transform:rotate(360deg)}}
  @media (max-width:600px){ .frame{height:80vh} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Speedometer_font_awesome.svg/120px-Speedometer_font_awesome.svg.png" alt="JK VIP">
        <h1>JK VIP SPEEDTEST</h1>
      </div>

      <p class="sub">Powered by M-Lab (official tester embedded)</p>

      <!-- ✅ live info bar -->
      <div class="info" id="info">
        <span class="chip"><i class="spin" id="spin"></i>Preparing…</span>
      </div>

      <!-- ✅ Official M-Lab test UI -->
      <iframe
        class="frame"
        src="https://speed.measurementlab.net/#/"
        loading="eager"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
        referrerpolicy="no-referrer">
      </iframe>

      <div class="foot">
        Your IP and measurement data are handled by Measurement Lab. See their
        <a href="https://www.measurementlab.net/privacy/" target="_blank" style="color:#9ec8ff">Privacy Policy</a>.
      </div>
    </div>
  </div>

<script>
(async function(){
  const info = document.getElementById('info');
  const spin = document.getElementById('spin');

  // helper to add a pill
  const pill = (label, value, klass='')=>{
    const s = document.createElement('span');
    s.className = 'chip '+klass;
    s.textContent = `${label}: ${value}`;
    info.appendChild(s);
  };

  // 1) Client IP + Geo (no API key)
  async function getClient() {
    // primary: ipapi.co (free, no key)
    try {
      const r = await fetch('https://ipapi.co/json/', {cache:'no-store'});
      if (r.ok) {
        const j = await r.json();
        return {
          ip: j.ip,
          city: j.city,
          region: j.region,
          country: j.country_name,
          org: j.org || j.asn || ''
        };
      }
    } catch {}
    // fallback: ipify + ipapi by IP
    try {
      const ipr = await fetch('https://api64.ipify.org?format=json', {cache:'no-store'}).then(x=>x.json());
      const geo = await fetch(`https://ipapi.co/${ipr.ip}/json/`, {cache:'no-store'}).then(x=>x.json());
      return {
        ip: ipr.ip,
        city: geo.city,
        region: geo.region,
        country: geo.country_name,
        org: geo.org || geo.asn || ''
      };
    } catch {}
    return null;
  }

  // 2) Nearest M-Lab server (city / host)
  async function getMlab(){
    try{
      const r = await fetch('https://locate.measurementlab.net/v2/nearest/ndt/ndt7',{cache:'no-store'});
      const j = await r.json();
      const s = j.results && j.results[0];
      if(!s) return null;
      let host = s.machine || '';
      if (!host && s.urls && s.urls[0] && s.urls[0].url) {
        try { host = new URL(s.urls[0].url).host; } catch {}
      }
      const city = (s.location && s.location.city) ? s.location.city : '';
      const country = (s.location && s.location.country) ? s.location.country : '';
      return { host, city, country };
    }catch{ return null; }
  }

  // 3) Render
  try {
    const [client, mlab] = await Promise.all([getClient(), getMlab()]);
    info.innerHTML = ''; // clear "Preparing"
    if (client) {
      pill('Your IP', client.ip, 'ok');
      pill('Location', `${client.city || '-'}, ${client.region || '-'}, ${client.country || '-'}`);
      if (client.org) pill('ISP', client.org);
    } else {
      pill('Your IP', '—'); pill('Location', '—');
    }
    if (mlab) {
      pill('M-Lab Server', `${mlab.host} (${mlab.city || '-'}, ${mlab.country || '-'})`);
    }
  } catch(e) {
    info.innerHTML = '';
    pill('Status', 'Info unavailable');
  }
})();
</script>
</body>
</html>
